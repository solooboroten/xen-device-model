MAGIC IOPORT 0x10-0x13 DEVICE MODEL

The device model covers two basic things:

-- Unplugging emulated devices.
-- Getting log messages out of the drivers and into dom0.

Drivers can tell if the device model is available by doing a two byte read
from port 0x10 and checking it against the magic number 0x49d2.

Unplugging emulated devices:
---------------------------

There are 3 versions of this protocol:

Version 0
---------

Devices are unplugged by type. Drivers write a two byte mask to port 0x10.

bit 0 causes all IDE disks to be unplugged
bit 1 causes all PCI NICs to be unplugged
bit 2 causes all IDE disks except the primary master to be unplugged (and
this, of course, should not be set simultaneously with bit 0 otherwise the
result is undefined).
bits 3-15 are reserved.

Version 1
---------

This extends version 0 by adding a capability to the device model to black-
list certain driver versions.
Drivers can discover that version 1 is available by reading a one byte
protocol version number from port 0x12. If this is set to 1 they can still
merrily carry on an unplug by type, since we have to support backwards
compatibility with protocol version 0. If they want to play nice though then
they should write a two byte product_id to port 0x12 and a four byte
build_number to port 0x10. If the product/build has been blacklisted then,
when the magic number is re-read from port 0x10, it will have changed to
something other than 0x49d2 and the drivers should skip the unplug.
The blacklist is, from qemu's point of view, handled mostly through xenstore.
A driver version is considered to be blacklisted if
/mh/driver-blacklist/{product_id}/{build_number} exists and is readable.
The master registry of product names and numbers is in qemu-xen-unstable's
xenstore.c.

Version 2
---------

If drivers wish to use version 2 of the protocol then they should do a
single byte write of 0x02 to port 0x13 before reading back the protocol
version from port 0x12. If version 2 is available then 0x02 will be read
back instead of 0x01.
If version 2 is in operation then the blacklist check as described above
must be performed as drivers will, by default, be blacklisted.
Under version 2, unplug is done by type and index. The unplug type is set
by making a single byte write to port 0x11:

1 -> Unplug IDE disks
2 -> Unplug PCI NICs

The unplug is then performed when an index is written in a single byte
write to port 0x13. If no device matching the (type,index) pair is present
then no unplug is performed.
Readers who are still awake will have noticed that port 0x13 is overloaded
as it was used to write in the unplug protocol version. Writing the
version is a one-off operation. After the initial write, port 0x13 is
only used for the unplug index, and the unplug type defaults to an
invalid value (0) so any subsequent write to port 0x13 will be ignored
unless protocol version 2 is in operation *and* a valid unplug type has
been set via port 0x11.

Logging to dom0:
---------------

Each single byte write to port 0x12 is considered to be an ASCII character
and is added to a log buffer. When the LF ('\n') character is encountered,
or when the log buffer fills it is flushed into the qemu log (although this
is gated on a token bucket throttling routine to avoid qemu hitting the
system log too hard).


Matrix of port read/write semantics:
-----------------------------------

PORT READS:

     |  1 BYTE            |  2 BYTE            |  4 BYTE
--------------------------------------------------------------------------------
0x10 | Reserved           | Magic number:      | Unused
     |                    | 0x49d2 (unless     |
     |                    | drivers are        |
     |                    | blacklisted)       |
     |                    |                    |
     |                    |                    |
--------------------------|                    |
0x11 | Unused             |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
-----------------------------------------------|
0x12 | Unplug protocol    | Unused             |
     | version in         |                    |
     | operation          |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
--------------------------|                    |
0x13 | Unused             |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |

PORT WRITES:

     |  1 BYTE            |  2 BYTE            |  4 BYTE
--------------------------------------------------------------------------------
0x10 | Reserved           | Version 0/1 unplug | build_number
     |                    | mask               |
     |                    |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
--------------------------|                    |
0x11 | Version 2 unplug   |                    |
     | type               |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
-----------------------------------------------|
0x12 | ASCII character to | product_id         |
     | log                |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
     |                    |                    |
--------------------------|                    |
0x13 | Unplug protocol    |                    |
     | version drivers    |                    |
     | wish to use        |                    |
     | (default == 1),    |                    |
     | then verson 2      |                    |
     | unplug index       |                    |

